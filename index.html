<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Cargas 2026</title>
    <style>
        :root { 
            --primary: #1a73e8; 
            --success: #1e8e3e;
            --danger: #d93025;
            --bg: #f1f3f4; 
        }

        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            background: var(--bg); 
            margin: 0; 
            padding: 10px; 
            padding-bottom: 50px;
        }

        .container { max-width: 900px; margin: auto; }
        
        h2 { text-align: center; color: var(--primary); font-size: 1.5rem; margin: 15px 0; }

        /* Formulario */
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); margin-bottom: 20px; }
        .form-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 10px; 
        }
        input, select { 
            padding: 12px; border: 1px solid #dadce0; border-radius: 8px; font-size: 14px; width: 100%; box-sizing: border-box; 
        }
        .btn-add { 
            background: var(--primary); color: white; border: none; padding: 12px; 
            border-radius: 8px; cursor: pointer; font-weight: bold; grid-column: 1 / -1; 
        }

        /* Buscador y Filtro */
        .search-box { display: flex; gap: 10px; margin-bottom: 15px; }

        /* Estilo AcordeÃ³n */
        .empresa-group { background: white; border-radius: 10px; margin-bottom: 10px; border: 1px solid #ddd; overflow: hidden; }
        .empresa-header { 
            padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; 
            background: #fff; transition: 0.2s;
        }
        .empresa-header:active { background: #f1f3f4; }
        .empresa-info b { color: var(--primary); text-transform: uppercase; font-size: 1.1em; display: block; }
        .empresa-info span { font-size: 0.85em; color: #5f6368; }
        .empresa-totals { text-align: right; }
        .empresa-totals b { color: var(--success); display: block; }
        .empresa-totals i { font-style: normal; font-size: 0.85em; color: #5f6368; }

        .empresa-content { 
            display: none; padding: 10px; background: #fafafa; border-top: 1px solid #eee;
            overflow-x: auto; /* IMPORTANTE: Permite scroll lateral en mÃ³vil */
            -webkit-overflow-scrolling: touch;
        }
        .empresa-content.active { display: block; }

        .desglose-chips { margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 5px; }
        .chip { background: #e8f0fe; color: var(--primary); padding: 4px 8px; border-radius: 15px; font-size: 0.75em; font-weight: bold; border: 1px solid #c2e7ff; }

        /* Tabla Responsive */
        table { width: 100%; border-collapse: collapse; min-width: 550px; }
        th { text-align: left; font-size: 0.75em; color: #70757a; padding: 8px; border-bottom: 2px solid #eee; }
        td { padding: 10px 8px; border-bottom: 1px solid #eee; font-size: 0.9em; }
        
        .badge-mat { background: #f1f3f4; padding: 3px 6px; border-radius: 4px; font-weight: 500; }
        .btn-del { 
            background: #fce8e6; color: var(--danger); border: 1px solid #fad2cf; 
            padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 1em;
        }

        .scroll-hint { font-size: 10px; color: #999; text-align: center; margin-top: 8px; }

        @media (max-width: 600px) {
            h2 { font-size: 1.2rem; }
            .empresa-header { padding: 12px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸšš GestiÃ³n de Contenedores</h2>

    <div class="card">
        <div class="form-grid">
            <input type="text" id="empresa" placeholder="Empresa (Nombre)">
            <input type="date" id="fecha">
            <input type="text" id="material" placeholder="Material (Hierro, Cobre...)">
            <input type="text" id="numContenedor" placeholder="NÂ° Contenedor">
            <input type="number" id="peso" placeholder="Peso (kg)">
            <input type="number" id="pago" placeholder="Pago ($)">
            <button class="btn-add" onclick="registrar()">+ REGISTRAR CARGA</button>
        </div>
    </div>

    <div class="search-box">
        <input type="text" id="buscador" onkeyup="renderizar()" placeholder="ðŸ” Buscar empresa..." style="flex: 2;">
        <select id="filtroAnio" onchange="renderizar()" style="flex: 1;">
            <option value="2025">2025</option>
            <option value="2026" selected>2026</option>
            <option value="2027">2027</option>
        </select>
    </div>

    <div id="listaEmpresas"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAHZnxZp4g4Ral7ZeFRaXPrYKkAEoCWLO0",
        authDomain: "segundosistema-76ed2.firebaseapp.com",
        projectId: "segundosistema-76ed2",
        storageBucket: "segundosistema-76ed2.firebasestorage.app",
        messagingSenderId: "523761658370",
        appId: "1:523761658370:web:0a82927b8be1d479b4951b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let todosLosDatos = [];

    // GUARDAR REGISTRO
    window.registrar = async () => {
        const emp = document.getElementById('empresa').value.trim();
        const fec = document.getElementById('fecha').value;
        const mat = document.getElementById('material').value.trim();

        if(!emp || !fec || !mat) return alert("Completa: Empresa, Fecha y Material");

        try {
            await addDoc(collection(db, "contenedores"), {
                empresa: emp.toLowerCase(),
                fecha: fec,
                anio: fec.split('-')[0],
                material: mat.toLowerCase(),
                numContenedor: document.getElementById('numContenedor').value || "N/A",
                peso: parseFloat(document.getElementById('peso').value) || 0,
                pago: parseFloat(document.getElementById('pago').value) || 0
            });
            // Limpiamos campos de carga pero dejamos empresa y fecha para rapidez
            document.getElementById('numContenedor').value = "";
            document.getElementById('peso').value = "";
            document.getElementById('pago').value = "";
        } catch (e) { alert("Error al guardar"); }
    };

    // ELIMINAR REGISTRO
    window.eliminar = async (e, id) => {
        e.stopPropagation(); // Evita que se cierre el acordeÃ³n al borrar
        if(confirm("Â¿Eliminar este registro?")) {
            await deleteDoc(doc(db, "contenedores", id));
        }
    };

    // ESCUCHAR CAMBIOS
    onSnapshot(collection(db, "contenedores"), (snap) => {
        todosLosDatos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderizar();
    });

    // ABRIR/CERRAR ACORDEÃ“N
    window.toggle = (id) => {
        const el = document.getElementById(id);
        el.classList.toggle('active');
    };

    // RENDERIZAR VISTA
    window.renderizar = () => {
        const buscador = document.getElementById('buscador').value.toLowerCase();
        const anioSel = document.getElementById('filtroAnio').value;
        const listaDiv = document.getElementById('listaEmpresas');
        listaDiv.innerHTML = "";

        // 1. Agrupar por empresa
        const grupos = todosLosDatos
            .filter(i => i.anio === anioSel && i.empresa.includes(buscador))
            .reduce((acc, item) => {
                if (!acc[item.empresa]) acc[item.empresa] = [];
                acc[item.empresa].push(item);
                return acc;
            }, {});

        // 2. Crear Acordeones
        for (const nombreEmpresa in grupos) {
            const filas = grupos[nombreEmpresa];
            const totalPeso = filas.reduce((s, i) => s + i.peso, 0);
            const totalPago = filas.reduce((s, i) => s + i.pago, 0);

            // Desglose por material
            const matObj = filas.reduce((acc, i) => {
                acc[i.material] = (acc[i.material] || 0) + i.peso;
                return acc;
            }, {});

            const idHtml = `group-${nombreEmpresa.replace(/\s+/g, '')}`;

            listaDiv.innerHTML += `
                <div class="empresa-group">
                    <div class="empresa-header" onclick="toggle('${idHtml}')">
                        <div class="empresa-info">
                            <b>${nombreEmpresa}</b>
                            <span>${filas.length} Cargas</span>
                        </div>
                        <div class="empresa-totals">
                            <b>$${totalPago.toLocaleString()}</b>
                            <i>${totalPeso.toLocaleString()} kg</i>
                        </div>
                    </div>
                    <div id="${idHtml}" class="empresa-content">
                        <div class="desglose-chips">
                            ${Object.entries(matObj).map(([m, p]) => `<span class="chip">${m.toUpperCase()}: ${p}kg</span>`).join('')}
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Material</th>
                                    <th>Contenedor</th>
                                    <th>Peso</th>
                                    <th>Pago</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filas.map(f => `
                                    <tr>
                                        <td>${f.fecha}</td>
                                        <td><span class="badge-mat">${f.material}</span></td>
                                        <td>${f.numContenedor}</td>
                                        <td>${f.peso}k</td>
                                        <td>$${f.pago}</td>
                                        <td><button class="btn-del" onclick="eliminar(event, '${f.id}')">ðŸ—‘</button></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="scroll-hint">â†” Desliza la tabla para ver mÃ¡s</div>
                    </div>
                </div>
            `;
        }
    };
</script>
</body>
</html>
